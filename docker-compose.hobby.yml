services:
  redis:
    image: redis:7-alpine
    container_name: hobby-redis
    restart: always
    healthcheck:
      test: [ "CMD", "redis-cli", "ping" ]
      interval: 10s
      timeout: 5s
      retries: 5
    ports:
      - "6379:6379"
    networks:
      - hobby-network

  medusa-backend:
    build:
      context: .
      dockerfile: Dockerfile.backend
      args:
        MEDUSA_BACKEND_URL: ${MEDUSA_BACKEND_URL}
    container_name: hobby-backend
    depends_on:
      redis:
        condition: service_healthy
    env_file:
      - .env
    environment:
      - NODE_OPTIONS="--max-old-space-size=6144"
      - MEDUSA_BACKEND_URL=${MEDUSA_BACKEND_URL}
      # Database URL should be in .env pointing to 172.16.16.80

    command: sh -c "npx medusa db:migrate && npx medusa db:sync-links && npx medusa start"
    ports:
      - "9000:9000"
      - "7001:7001"
    volumes:
      - ./.env:/app/my-medusa-store/.env:ro
      - hobby_uploads:/app/my-medusa-store/uploads
    restart: always
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:9000/health" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 600s
    networks:
      - hobby-network

  medusa-storefront:
    build:
      context: .
      dockerfile: Dockerfile.storefront
      # CRITICAL: These ARGS are needed for Next.js build time!
      args:
        NEXT_PUBLIC_MEDUSA_BACKEND_URL: ${MEDUSA_BACKEND_URL}
        NEXT_PUBLIC_BASE_URL: ${NEXT_PUBLIC_BASE_URL}
        NEXT_PUBLIC_MEDUSA_PUBLISHABLE_KEY: ${NEXT_PUBLIC_MEDUSA_PUBLISHABLE_KEY}
        NEXT_PUBLIC_DEFAULT_REGION: tr
        NEXT_PUBLIC_STORE_ID: hobby
    container_name: hobby-storefront
    env_file:
      - .env
    environment:
      MEDUSA_BACKEND_URL: http://hobby-backend:9000
      NEXT_PUBLIC_MEDUSA_BACKEND_URL: ${MEDUSA_BACKEND_URL}
      NEXT_PUBLIC_MEDUSA_PUBLISHABLE_KEY: ${NEXT_PUBLIC_MEDUSA_PUBLISHABLE_KEY}
      NEXT_PUBLIC_BASE_URL: ${NEXT_PUBLIC_BASE_URL}
      BETTER_AUTH_SECRET: ${BETTER_AUTH_SECRET}
      BETTER_AUTH_URL: ${BETTER_AUTH_URL}
      NEXT_PUBLIC_DEFAULT_REGION: tr
      NEXT_PUBLIC_STORE_ID: hobby
    ports:
      - "8000:8000"
    volumes:
      # Removed node_modules volume override to prevent overwriting built modules
      - hobby_storefront_next:/app/my-medusa-storefront/.next
    restart: always
    networks:
      - hobby-network
    depends_on:
      medusa-backend:
        condition: service_healthy

  medusa-clay-storefront:
    build:
      context: .
      dockerfile: Dockerfile.storefront
      args:
        NEXT_PUBLIC_MEDUSA_BACKEND_URL: ${MEDUSA_BACKEND_URL}
        NEXT_PUBLIC_BASE_URL: ${NEXT_PUBLIC_BASE_URL}
        NEXT_PUBLIC_MEDUSA_PUBLISHABLE_KEY: ${CLAY_PUBLISHABLE_KEY}
        NEXT_PUBLIC_DEFAULT_REGION: tr
        NEXT_PUBLIC_STORE_ID: clay
    container_name: hobby-clay-storefront
    env_file:
      - .env
    environment:
      MEDUSA_BACKEND_URL: http://hobby-backend:9000
      NEXT_PUBLIC_MEDUSA_BACKEND_URL: ${MEDUSA_BACKEND_URL}
      NEXT_PUBLIC_MEDUSA_PUBLISHABLE_KEY: ${CLAY_PUBLISHABLE_KEY}
      NEXT_PUBLIC_BASE_URL: ${NEXT_PUBLIC_BASE_URL}
      BETTER_AUTH_SECRET: ${BETTER_AUTH_SECRET}
      BETTER_AUTH_URL: ${BETTER_AUTH_URL}
      NEXT_PUBLIC_DEFAULT_REGION: tr
      NEXT_PUBLIC_STORE_ID: clay
    ports:
      - "8001:8000"
    volumes:
      - hobby_clay_next:/app/my-medusa-storefront/.next
    restart: always
    networks:
      - hobby-network
    depends_on:
      medusa-backend:
        condition: service_healthy

  medusa-sedefli-storefront:
    build:
      context: .
      dockerfile: Dockerfile.storefront
      args:
        NEXT_PUBLIC_MEDUSA_BACKEND_URL: ${MEDUSA_BACKEND_URL}
        NEXT_PUBLIC_BASE_URL: ${NEXT_PUBLIC_BASE_URL}
        NEXT_PUBLIC_MEDUSA_PUBLISHABLE_KEY: ${SEDEFLI_PUBLISHABLE_KEY}
        NEXT_PUBLIC_DEFAULT_REGION: tr
        NEXT_PUBLIC_STORE_ID: sedefli
    container_name: hobby-sedefli-storefront
    env_file:
      - .env
    environment:
      MEDUSA_BACKEND_URL: http://hobby-backend:9000
      NEXT_PUBLIC_MEDUSA_BACKEND_URL: ${MEDUSA_BACKEND_URL}
      NEXT_PUBLIC_MEDUSA_PUBLISHABLE_KEY: ${SEDEFLI_PUBLISHABLE_KEY}
      NEXT_PUBLIC_BASE_URL: ${NEXT_PUBLIC_BASE_URL}
      BETTER_AUTH_SECRET: ${BETTER_AUTH_SECRET}
      BETTER_AUTH_URL: ${BETTER_AUTH_URL}
      NEXT_PUBLIC_DEFAULT_REGION: tr
      NEXT_PUBLIC_STORE_ID: sedefli
    ports:
      - "8002:8000"
    volumes:
      - hobby_sedefli_next:/app/my-medusa-storefront/.next
    restart: always
    networks:
      - hobby-network
    depends_on:
      medusa-backend:
        condition: service_healthy

volumes:
  hobby_uploads:
    driver: local
  hobby_minio_data:
    driver: local
  hobby_storefront_next:
    driver: local
  hobby_clay_next:
    driver: local
  hobby_sedefli_next:
    driver: local

networks:
  hobby-network:
    driver: bridge
    ipam:
      config:
        - subnet: 10.100.0.0/16
